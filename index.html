<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>–°—Ç–æ–ø –ª–∏—Å—Ç</title>
<meta name="theme-color" content="#0b1020">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Stop List">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
<script>
  (function () {
    try {
      var t = localStorage.getItem("stoplist_theme");
      document.documentElement.dataset.theme = t === "light" ? "light" : "dark";
    } catch (e) {
      document.documentElement.dataset.theme = "dark";
    }
  })();
</script>
<link rel="stylesheet" href="styles.css">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js" defer></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js" defer></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js" defer></script>
<script src="app.js" defer></script>

</head>
<body>
<div id="splash-screen" class="splash-screen" aria-hidden="true">
  <div class="splash-card">
    <img src="apple-touch-icon.png" alt="" class="splash-icon">
    <div class="splash-title">–°—Ç–æ–ø –ª–∏—Å—Ç</div>
  </div>
</div>
<div class="layout">
  <header class="page-header">
    <h1>–°—Ç–æ–ø –ª–∏—Å—Ç</h1>
    <div id="header-time" class="header-time" aria-live="polite"></div>
    <div id="header-weather" class="header-weather" aria-live="polite">–û–¥–µ—Å—Å–∞: –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ–≥–æ–¥—ã –∏ –≤–æ–¥—ã...</div>
    <nav class="header-tabs" role="tablist" aria-label="–†–∞–∑–¥–µ–ª—ã">
      <button id="tab-stoplist" class="header-tab" type="button" role="tab" aria-selected="true" aria-controls="view-stoplist">–°—Ç–æ–ø –ª–∏—Å—Ç</button>
      <button id="tab-chat" class="header-tab" type="button" role="tab" aria-selected="false" aria-controls="view-chat">–ß–∞—Ç</button>
    </nav>
    <div class="header-actions">
      <button id="open-settings" class="settings-btn" type="button" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="currentColor" stroke-width="2"/>
          <path d="M19.4 15a8.9 8.9 0 0 0 .1-1 8.9 8.9 0 0 0-.1-1l2-1.6-2-3.4-2.4 1a8.3 8.3 0 0 0-1.7-1L15 2H9l-.3 2.9a8.3 8.3 0 0 0-1.7 1l-2.4-1-2 3.4 2 1.6a8.9 8.9 0 0 0-.1 1c0 .3 0 .7.1 1l-2 1.6 2 3.4 2.4-1a8.3 8.3 0 0 0 1.7 1L9 22h6l.3-2.9a8.3 8.3 0 0 0 1.7-1l2.4 1 2-3.4-2-1.6Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
    <button id="theme-toggle" class="theme-toggle" type="button" role="switch" aria-checked="false" aria-label="–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞">
      <span class="theme-toggle-track" aria-hidden="true">
        <span class="theme-toggle-thumb" aria-hidden="true">
          <svg class="theme-toggle-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M9 21h6M10 17h4M12 3a7 7 0 0 0-4 12c.6.6 1 1.3 1 2h6c0-.7.4-1.4 1-2a7 7 0 0 0-4-12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
      </span>
    </button>
    <div id="deviceInfo"
      style="
      position:fixed;
      top:calc(10px + env(safe-area-inset-top));
      left:10px;
      background:black;
      color:white;
      padding:6px 8px;
      border-radius:8px;
      font-size:11px;
      line-height:1.2;
      z-index:9999;
      opacity:0.92;
      transition:opacity .5s ease;">
      –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞...
    </div>
    <script>
      function detectBrowser(ua) {
        if (/Edg/i.test(ua)) return "Edge";
        if (/OPR|Opera/i.test(ua)) return "Opera";
        if (/CriOS|Chrome/i.test(ua)) return "Chrome";
        if (/FxiOS|Firefox/i.test(ua)) return "Firefox";
        if (/Safari/i.test(ua)) return "Safari";
        return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä";
      }

      function detectDevice() {
        const ua = navigator.userAgent || "";
        const isIOS = /iPhone|iPad|iPod/i.test(ua);
        const isAndroid = /Android/i.test(ua);
        const isSafari = /Safari/i.test(ua) && !/CriOS|FxiOS|EdgiOS|OPiOS/i.test(ua);
        const isStandalone = window.navigator.standalone === true || window.matchMedia("(display-mode: standalone)").matches;
        const browser = detectBrowser(ua);
        let result = "";

        if (isStandalone) {
          result = "‚úÖ APP mode";
        } else if (isIOS && isSafari) {
          result = "üì± iPhone ‚Ä¢ Safari";
        } else if (isIOS && !isSafari) {
          result = `üì± iPhone ‚Ä¢ ${browser}`;
        } else if (isAndroid) {
          result = `ü§ñ Android ‚Ä¢ ${browser}`;
        } else {
          result = `üíª –ü–ö ‚Ä¢ ${browser}`;
        }

        const el = document.getElementById("deviceInfo");
        if (!el) return;
        el.innerText = result;
        setTimeout(() => {
          el.style.opacity = "0";
          setTimeout(() => { el.style.display = "none"; }, 520);
        }, 5000);
      }

      detectDevice();
    </script>
  </header>
  <div class="views" aria-label="–°–æ–¥–µ—Ä–∂–∏–º–æ–µ">
    <main id="view-stoplist" class="view" role="tabpanel" aria-labelledby="tab-stoplist">
      <div id="app"></div>
      <section class="rating-section" aria-live="polite">
        <div class="rating-head">
          <h2 class="rating-title">–†–µ–π—Ç–∏–Ω–≥ —Å—Ç–æ–ø –ª–∏—Å—Ç–∞</h2>
          <button id="reset-rating" class="rating-reset-btn" type="button">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
        <div id="rating-summary" class="rating-summary"></div>
        <div id="rating-list" class="rating-list"></div>
      </section>
    </main>
    <main id="view-chat" class="view" hidden role="tabpanel" aria-labelledby="tab-chat">
      <section class="chat-card" aria-label="–ß–∞—Ç">
        <div id="chat-messages" class="chat-messages" aria-live="polite"></div>
        <div id="chat-reply" class="chat-reply" hidden>
          <div class="chat-reply-text">
            <div id="chat-reply-meta" class="chat-reply-meta"></div>
            <div id="chat-reply-snippet" class="chat-reply-snippet"></div>
          </div>
          <button id="chat-reply-cancel" class="chat-reply-cancel" type="button" aria-label="–û—Ç–º–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç">√ó</button>
        </div>
        <div id="chat-upload-status" class="chat-upload-status" hidden aria-live="polite"></div>
        <form id="chat-form" class="chat-form" autocomplete="off">
          <input id="chat-input" class="chat-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" maxlength="600">
          <button id="chat-send" class="chat-send" type="submit" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M4 12h15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M13 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </form>
      </section>
    </main>
  </div>
</div>

<div id="settings-overlay" class="sheet-overlay" hidden aria-hidden="true">
  <div class="sheet-backdrop" data-sheet-close="1" aria-hidden="true"></div>
  <aside class="sheet" role="dialog" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
    <div class="sheet-handle" aria-hidden="true"></div>
    <div class="sheet-head">
      <div class="sheet-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
      <button id="settings-close" class="sheet-close" type="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
    </div>
    <div class="sheet-body">
      <section class="sheet-card" aria-label="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">
        <div class="sheet-card-title">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
        <div class="pref-row">
          <div class="pref-text">
            <div class="pref-label">–ù–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏</div>
            <div id="newitem-notifs-status" class="pref-desc">–°—Ç–∞—Ç—É—Å: ‚Ä¶</div>
          </div>
          <button id="toggle-newitem-notifs" class="pref-toggle" type="button" role="switch" aria-checked="false" aria-label="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏—è—Ö">
            <span class="pref-toggle-track" aria-hidden="true">
              <span class="pref-toggle-thumb" aria-hidden="true"></span>
            </span>
          </button>
        </div>
        <div id="newitem-notifs-hint" class="pref-hint"></div>
      </section>
	      <section class="sheet-card" aria-label="Telegram">
	        <div class="sheet-card-title">Telegram</div>
	        <div class="pref-row">
	          <div class="pref-text">
	            <div class="pref-label">–°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏</div>
	            <div id="tg-status" class="pref-desc">–°—Ç–∞—Ç—É—Å: ‚Ä¶</div>
	          </div>
	          <button id="toggle-tg" class="pref-toggle" type="button" role="switch" aria-checked="false" aria-label="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ Telegram">
	            <span class="pref-toggle-track" aria-hidden="true">
	              <span class="pref-toggle-thumb" aria-hidden="true"></span>
	            </span>
	          </button>
	        </div>
	        <button id="tg-test" class="sheet-primary" type="button">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç</button>
	        <div id="tg-hint" class="pref-hint"></div>
	      </section>
      <section class="sheet-card" aria-label="–ó–∞—â–∏—Ç–∞">
        <div class="sheet-card-title">–ó–∞—â–∏—Ç–∞</div>
        <div class="pref-row">
          <div class="pref-text">
            <div class="pref-label">–ü–∞—Ä–æ–ª—å –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            <div id="settings-lock-status" class="pref-desc">–°—Ç–∞—Ç—É—Å: ‚Ä¶</div>
          </div>
          <button id="toggle-settings-lock" class="pref-toggle" type="button" role="switch" aria-checked="false" aria-label="–ü–∞—Ä–æ–ª—å –Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫">
            <span class="pref-toggle-track" aria-hidden="true">
              <span class="pref-toggle-thumb" aria-hidden="true"></span>
            </span>
          </button>
        </div>
        <button id="settings-lock-change" class="sheet-secondary" type="button">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
        <div id="settings-lock-hint" class="pref-hint"></div>
      </section>
      <button id="clear-stop-list" class="sheet-danger" type="button">–£–¥–∞–ª–∏—Ç—å —Å—Ç–æ–ø –ª–∏—Å—Ç</button>
      <div class="sheet-hint">–ü–æ—Ç—Ä–µ–±—É—é—Ç—Å—è –ø–∞—Ä–æ–ª—å –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ.</div>
    </div>
  </aside>
</div>
<aside id="iphone-install-prompt" class="ios-install-prompt" aria-live="polite" aria-label="Install app prompt for iPhone">
  <button id="iphone-install-close" class="ios-install-close" type="button" aria-label="Close iPhone install prompt">√ó</button>
  <div class="ios-install-head">
    <div class="ios-install-icon" aria-hidden="true">SL</div>
    <div class="ios-install-meta">
      <div class="ios-install-title">Stop List</div>
      <div class="ios-install-desc">Install on iPhone Home Screen</div>
    </div>
  </div>
  <div class="ios-install-steps">Tap Share ‚Üí Add to Home Screen</div>
  <div class="ios-install-actions">
    <button id="open-in-safari" class="open-in-safari" type="button">–û—Ç–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ Safari</button>
  </div>
</aside>
<aside id="android-install-prompt" class="ios-install-prompt" aria-live="polite" aria-label="Install app prompt for Android">
  <button id="android-install-close" class="ios-install-close" type="button" aria-label="Close Android install prompt">√ó</button>
  <div class="ios-install-head">
    <div class="ios-install-icon" aria-hidden="true">SL</div>
    <div class="ios-install-meta">
      <div class="ios-install-title">Stop List</div>
      <div class="ios-install-desc">Install app in Google Chrome</div>
    </div>
  </div>
  <div class="ios-install-steps">In Chrome: Menu ‚ãÆ ‚Üí Add to Home screen</div>
  <div class="ios-install-actions">
    <button id="install-in-chrome" class="open-in-chrome" type="button">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ Chrome</button>
  </div>
</aside>
</body>
</html>
